name: Update Toffee Channels

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-toffee:
    runs-on: ubuntu-latest

    env:
      TOFFEE_ZIP_PASSWORD: ${{ secrets.TOFFEE_ZIP_PASSWORD }}
      TOFFEE_TOKEN: ${{ secrets.TOFFEE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install required tools
        run: |
          sudo apt update
          sudo apt install -y p7zip-full python3-pip
          pip install requests

      - name: Unzip AES256 protected script
        run: |
          mkdir -p tmp_script
          7z x update_toffee.zip -p"$TOFFEE_ZIP_PASSWORD" -otmp_script

      - name: Run Python script
        env:
          TOFFEE_TOKEN: ${{ secrets.TOFFEE_TOKEN }}
        run: |
          python3 tmp_script/update_toffee.py

      - name: Debug outputs
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "---- file sizes ----"
          for f in toffee_OTT_Navigator.m3u toffee_NS_Player.m3u toffee_channel_data.json; do
            if [ -f "$f" ]; then
              echo "$f exists, size=$(stat -c%s "$f") bytes"
              head -n 3 "$f" || true
            else
              echo "$f MISSING"
            fi
          done

      - name: Remove script after execution
        run: |
          rm -rf tmp_script

      # (Optional) Artifact ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¶‡¶æ‡¶ì‚Äî‡¶Ø‡¶¶‡¶ø commit fail ‡¶π‡¶≤‡ßá‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã
      - name: Upload outputs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: toffee-outputs
          path: |
            toffee_OTT_Navigator.m3u
            toffee_NS_Player.m3u
            toffee_channel_data.json

      - name: Commit and push updated files if changed
        run: |
          git config user.name "ToffeeBot"
          git config user.email "toffeebot@example.com"
          git add toffee_OTT_Navigator.m3u toffee_NS_Player.m3u toffee_channel_data.json
          git diff --cached --quiet || (git commit -m "üîÅ Auto update Toffee streams" && git push)
